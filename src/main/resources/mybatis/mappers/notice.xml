<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.NoticeDAO">

  <!-- 컬럼 ↔ DTO 필드 “정확히” 묶기 -->
  <resultMap id="NoticeMap" type="com.boot.dto.NoticeDTO">
    <id     column="NOTICE_ID" property="notice_id"/>
    <result column="TITLE"     property="title"/>
    <result column="CONTENT"   property="content"/>
    <result column="VIEWS"     property="views"/>
    <result column="CREATED_AT" property="created_at"/>
    <result column="IS_URGENT" property="is_urgent"/>
    <result column="UPDATED_AT" property="updated_at"/>
  </resultMap>

  <select id="listWithPaging" resultMap="NoticeMap">
    SELECT notice_id, title, views, created_at, is_urgent
    FROM (
      SELECT notice_id, title, views, created_at, is_urgent, ROWNUM as rnum
      FROM (
        SELECT notice_id, title, views,
               TO_CHAR(created_at, 'YYYY-MM-DD') as created_at,
               is_urgent
        FROM RECALL_NOTICE_DB
        ORDER BY notice_id DESC
      )
      WHERE ROWNUM &lt;= #{pageNum} * #{amount}
    )
    WHERE rnum > (#{pageNum} - 1) * #{amount}
  </select>

  <select id="getTotalCount" resultType="int">
    SELECT COUNT(*) FROM RECALL_NOTICE_DB
  </select>

  <insert id="write" parameterType="com.boot.dto.NoticeDTO">
    <selectKey keyProperty="notice_id" resultType="long" order="BEFORE">
      SELECT RECALL_NOTICE_SEQ.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO RECALL_NOTICE_DB (notice_id, title, content, is_urgent)
    VALUES (#{notice_id}, #{title}, #{content}, NVL(#{is_urgent, jdbcType=CHAR}, 'N'))
  </insert>

  <select id="getNotice" parameterType="long" resultMap="NoticeMap">
    SELECT notice_id, title, content, views,
           TO_CHAR(created_at,'YYYY-MM-DD HH24:MI') as created_at,
           is_urgent, updated_at
    FROM RECALL_NOTICE_DB
    WHERE notice_id = #{notice_id}
  </select>

  <update id="incrementViews" parameterType="long">
    UPDATE RECALL_NOTICE_DB
    SET views = views + 1
    WHERE notice_id = #{notice_id}
  </update>

  <update id="modify" parameterType="com.boot.dto.NoticeDTO">
    UPDATE RECALL_NOTICE_DB
    SET title = #{title},
        content = #{content},
        is_urgent = #{is_urgent},
        updated_at = SYSDATE
    WHERE notice_id = #{notice_id}
  </update>

  <delete id="delete" parameterType="long">
    DELETE FROM RECALL_NOTICE_DB
    WHERE notice_id = #{notice_id}
  </delete>
</mapper>
